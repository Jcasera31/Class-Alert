{% extends "base.html" %}
{% block title %}My Schedule{% endblock %}

{% block content %}

<a href="{{ url_for('dashboard.home') }}" class="back-btn">
    <i class="ri-arrow-left-line"></i> Back
</a>

<div class="card">
    <div class="schedule-header">
        <h2 class="schedule-title">ðŸ“˜ My Class Schedule</h2>

        <div class="top-right-controls">

            <!-- SEARCH BAR -->
            <form method="GET" action="{{ url_for('schedule.view_schedules') }}" style="display:inline;">
                <input type="text" name="q" placeholder="Search subject..." value="{{ q or '' }}" />
                {% if selected_semester and selected_year %}
                    <input type="hidden" name="semester" value="{{ selected_semester }}||{{ selected_year }}">
                {% endif %}
                <button type="submit">Search</button>
            </form>

            <!-- TERM FILTER -->
            <form method="GET" action="{{ url_for('schedule.view_schedules') }}" style="display:inline;">
                <select name="semester" onchange="this.form.submit()">
                    <option value="">All Terms</option>
                    {% for sem, yr in terms %}
                        <option value="{{ sem }}||{{ yr }}"
                            {% if selected_semester == sem and selected_year == yr %}selected{% endif %}>
                            {{ sem }} - {{ yr }}
                        </option>
                    {% endfor %}
                </select>
            </form>

            <!-- ADD BUTTON -->
            <button type="button" id="addBtn">+ Add Class</button>

        </div>
    </div>

    <table class="schedule-table">
        <thead>
            <tr>
                <th>Subject</th>
                <th>Days</th>
                <th>Time</th>
                <th>Semester</th>
                <th>Year</th>
                <th>Alarm</th>
                <th>Actions</th>
            </tr>
        </thead>

        <tbody>
            {% for s in schedules %}
            <tr>
                <td>{{ s.subject }}</td>
                <td>{{ s.days }}</td>
                <td>{{ s.time }}</td>
                <td><span class="semester-badge">{{ s.semester }}</span></td>
                <td><span class="year-badge">{{ s.academic_year }}</span></td>
                <td>{{ "On" if s.alarm_enabled else "Off" }} ({{ s.alarm_offset_minutes }}m)</td>
                <td class="actions-cell">
                    <button class="editBtn"
                        data-id="{{ s.id }}"
                        data-subject="{{ s.subject }}"
                        data-days="{{ s.days }}"
                        data-time="{{ s.time }}"
                        data-semester="{{ s.semester }}"
                        data-year="{{ s.academic_year }}"
                        data-alarm="{{ '1' if s.alarm_enabled else '0' }}"
                        data-offset="{{ s.alarm_offset_minutes }}"
                        data-custom="{{ s.custom_alarm_time or '' }}">
                        Edit
                    </button>

                    <form class="deleteForm"
                          method="POST"
                          action="{{ url_for('schedule.delete_schedule_route', schedule_id=s.id) }}"
                          onsubmit="return confirm('Delete this class?');">
                        <button type="submit">Delete</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- MODAL -->
<div id="modal" class="modal">
    <div class="modal-inner">

        <h3 id="modalTitle">Add Class</h3>

        <form id="schedForm" method="POST" action="{{ url_for('schedule.add_schedule') }}">
            <input type="hidden" name="id" id="schedId">

            <label>Subject:
                <input name="subject" id="subject" required>
            </label>

            <label>Days:</label>
            <div style="display:flex; flex-wrap:wrap; gap:10px; margin-bottom:10px;" id="daysGroup">
                {% set day_options = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'] %}
                {% for d in day_options %}
                <label style="display:flex; align-items:center; gap:6px;">
                    <input type="checkbox" name="days" value="{{ d }}" class="day-checkbox"> {{ d }}
                </label>
                {% endfor %}
            </div>

            <label>Time:
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                    <div>
                        <small>Start</small>
                        <input type="time" id="timeStart" step="1800" required>
                    </div>
                    <div>
                        <small>End</small>
                        <input type="time" id="timeEnd" step="1800" required>
                    </div>
                </div>
                <input type="hidden" name="time" id="timeHidden" value="">
            </label>

            <label>Semester:
                <select name="semester" id="semester" required>
                    <option value="">Select semester</option>
                    <option value="1st Semester">1st Semester</option>
                    <option value="2nd Semester">2nd Semester</option>
                    <option value="Summer">Summer</option>
                    <option value="Midyear">Midyear</option>
                </select>
            </label>

            <label>Academic Year:
                <select name="academic_year" id="academic_year">
                    <option value="">Auto (based on current date)</option>
                    <option value="2023-2024">2023-2024</option>
                    <option value="2024-2025">2024-2025</option>
                    <option value="2025-2026">2025-2026</option>
                    <option value="2026-2027">2026-2027</option>
                    <option value="2027-2028">2027-2028</option>
                </select>
            </label>

            <label>
                <input type="checkbox" name="alarm_enabled" id="alarm_enabled"> Alarm enabled
            </label>

            <label>Alarm offset minutes:
                <input name="alarm_offset" id="alarm_offset" type="number" value="30">
            </label>

            <label>Custom alarm time:
                <input name="custom_alarm_time" id="custom_alarm_time" type="time" step="60">
            </label>

            <div class="modal-actions">
                <button type="submit">Save</button>
                <button type="button" id="cancelModal">Cancel</button>
            </div>
        </form>

    </div>
</div>

{% endblock %}


{% block scripts %}
<!-- ========================= -->
<!-- JAVASCRIPT (MUST BE HERE) -->
<!-- ========================= -->
<script>
document.addEventListener("DOMContentLoaded", () => {
    console.log("Schedule page JavaScript loaded");

    const modal = document.getElementById("modal");
    const addBtn = document.getElementById("addBtn");
    const cancelModal = document.getElementById("cancelModal");
    const schedForm = document.getElementById("schedForm");
    const dayCheckboxes = Array.from(document.querySelectorAll('.day-checkbox'));
    const timeStart = document.getElementById('timeStart');
    const timeEnd = document.getElementById('timeEnd');
    const timeHidden = document.getElementById('timeHidden');

    // Build time options from 7:00 AM to 9:00 PM in 30-minute increments, with 60m and 90m durations
    const toLabel = (val) => {
        if (!val) return '';
        const [h, m] = val.split(':').map(Number);
        const period = h >= 12 ? 'PM' : 'AM';
        const h12 = ((h + 11) % 12) + 1;
        return `${h12.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')} ${period}`;
    };

    const setHiddenTime = () => {
        if (!timeStart || !timeEnd || !timeHidden) return;
        if (!timeStart.value || !timeEnd.value) {
            timeHidden.value = '';
            return;
        }
        // ensure end after start
        if (timeEnd.value <= timeStart.value) {
            timeHidden.value = '';
            return;
        }
        timeHidden.value = `${toLabel(timeStart.value)} - ${toLabel(timeEnd.value)}`;
    };

    if (timeStart) timeStart.addEventListener('change', setHiddenTime);
    if (timeEnd) timeEnd.addEventListener('change', setHiddenTime);

    // Debug logging
    console.log("Modal element:", modal);
    console.log("Add button:", addBtn);
    console.log("Cancel button:", cancelModal);
    console.log("Form element:", schedForm);

    if (!modal || !addBtn || !cancelModal || !schedForm) {
        console.error("Missing required elements!");
        return;
    }

    // Add Class button handler
    addBtn.addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();
        console.log("Add button clicked");
        
        document.getElementById("modalTitle").innerText = "Add Class";
        schedForm.action = "{{ url_for('schedule.add_schedule') }}";

        document.getElementById("schedId").value = "";
        document.getElementById("subject").value = "";
        dayCheckboxes.forEach(cb => cb.checked = false);
        if (timeStart) timeStart.value = "";
        if (timeEnd) timeEnd.value = "";
        if (timeHidden) timeHidden.value = "";
        document.getElementById("semester").value = "";
        document.getElementById("academic_year").value = "";
        document.getElementById("alarm_enabled").checked = true;
        document.getElementById("alarm_offset").value = 30;
        document.getElementById("custom_alarm_time").value = "";

        modal.style.display = "flex";
        console.log("Modal opened for adding");
    });

    // Cancel button handler
    cancelModal.addEventListener("click", (e) => {
        e.preventDefault();
        console.log("Cancel clicked");
        modal.style.display = "none";
    });

    // Edit buttons handler
    const editButtons = document.querySelectorAll(".editBtn");
    console.log("Found edit buttons:", editButtons.length);
    
    editButtons.forEach(btn => {
        btn.addEventListener("click", (e) => {
            e.preventDefault();
            e.stopPropagation();
            console.log("Edit button clicked for ID:", btn.dataset.id);

            document.getElementById("modalTitle").innerText = "Edit Class";

            const id = btn.dataset.id;
            schedForm.action = `/schedule/edit/${id}`;

            document.getElementById("schedId").value = id;
            document.getElementById("subject").value = btn.dataset.subject || "";
            const existingDays = (btn.dataset.days || '').split(',').map(d => d.trim().toLowerCase());
            dayCheckboxes.forEach(cb => {
                cb.checked = existingDays.includes(cb.value.toLowerCase());
            });
            const existingTime = btn.dataset.time || "";
            const match = existingTime.match(/^(\d{1,2}:\d{2}\s*[AP]M)\s*-\s*(\d{1,2}:\d{2}\s*[AP]M)$/i);
            const to24 = (s) => {
                if (!s) return '';
                const parts = s.trim().toUpperCase().match(/(\d{1,2}):(\d{2})\s*(AM|PM)/);
                if (!parts) return '';
                let h = parseInt(parts[1], 10);
                const m = parts[2];
                const ap = parts[3];
                if (ap === 'PM' && h !== 12) h += 12;
                if (ap === 'AM' && h === 12) h = 0;
                return `${h.toString().padStart(2,'0')}:${m}`;
            };
            if (match) {
                const start = to24(match[1]);
                const end = to24(match[2]);
                if (timeStart) timeStart.value = start;
                if (timeEnd) timeEnd.value = end;
                setHiddenTime();
            } else {
                if (timeStart) timeStart.value = '';
                if (timeEnd) timeEnd.value = '';
                if (timeHidden) timeHidden.value = existingTime; // fallback raw
            }
            document.getElementById("semester").value = btn.dataset.semester || "";
            document.getElementById("academic_year").value = btn.dataset.year || "";
            document.getElementById("alarm_enabled").checked = btn.dataset.alarm === "1";
            document.getElementById("alarm_offset").value = btn.dataset.offset || 30;
            document.getElementById("custom_alarm_time").value = btn.dataset.custom || "";

            modal.style.display = "flex";
            console.log("Modal opened for editing");
        });
    });

    // Ensure timeHidden has a value before submit
    schedForm.addEventListener('submit', (e) => {
        setHiddenTime();
        if (!timeHidden || !timeHidden.value) {
            e.preventDefault();
            alert('Please choose a valid start and end time (end must be after start).');
        }
    });

    // Close modal when clicking outside
    window.addEventListener("click", (event) => {
        if (event.target === modal) {
            console.log("Clicked outside modal");
            modal.style.display = "none";
        }
    });

    // Close modal on Escape key
    document.addEventListener("keydown", (event) => {
        if (event.key === "Escape" && modal.style.display === "flex") {
            console.log("Escape pressed");
            modal.style.display = "none";
        }
    });
});
</script>
{% endblock %}
